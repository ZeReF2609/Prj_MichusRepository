@model IEnumerable<Michus.Models.Producto>

@{
    ViewData["Title"] = "Gestión de Productos";
    int currentPage = ViewData["CurrentPage"] != null ? Convert.ToInt32(ViewData["CurrentPage"]) : 1;
    int totalPages = ViewData["TotalPages"] != null ? Convert.ToInt32(ViewData["TotalPages"]) : 1;
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<link rel="stylesheet" href="~/assets/css/vistasBootstrap.css">

<h1>@ViewData["Title"]</h1>

<link rel="stylesheet" href="~/assets/css/Producto.css">

<!-- Botón para abrir el modal de agregar producto -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productoModal" onclick="clearForm()">
    Agregar Producto
</button>

<!-- Tabla de productos -->
<table class="table table-striped mt-3">
    <thead>
        <tr>
            <th>ID Producto</th>
            <th>Nombre</th>
            <th>Nombre Web</th>
            <th>Descripción</th>
            <th>Categoría</th>
            <th>Fecha Comercial</th>
            <th>Precio</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var producto in Model)
        {
            <tr>
                <td>@producto.IdProducto</td>
                <td>@producto.ProdNom</td>
                <td>@producto.ProdNomweb</td>
                <td>@producto.Descripcion</td>
                <td>@producto.IdCategoria</td>
                <td>@(producto.ProdFchcmrl.HasValue ? producto.ProdFchcmrl.Value.ToString("dd/MM/yyyy") : "N/A")</td>
                <td>@producto.Precio.ToString("C")</td>
                <td>@(producto.Estado == 1 ? "Activo" : "Inactivo")</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editarProducto('@producto.IdProducto')">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="toggleProduct('@producto.IdProducto', @producto.Estado)">
                        @(producto.Estado == 1 ? "Desactivar" : "Activar")
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Controles de paginación -->
<nav aria-label="Paginación">
    <ul class="pagination justify-content-center">
        @if (currentPage > 1)
        {
            <li class="page-item">
                <a class="page-link" href="@Url.Action("Index", new { page = currentPage - 1 })">Anterior</a>
            </li>
        }

        @for (int i = 1; i <= totalPages; i++)
        {
            <li class="page-item @(i == currentPage ? "active" : "")">
                <a class="page-link" href="@Url.Action("Index", new { page = i })">@i</a>
            </li>
        }

        @if (currentPage < totalPages)
        {
            <li class="page-item">
                <a class="page-link" href="@Url.Action("Index", new { page = currentPage + 1 })">Siguiente</a>
            </li>
        }
    </ul>
</nav>

<!-- Modal para agregar/editar producto -->
<div class="modal fade" id="productoModal" tabindex="-1" role="dialog" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productoModalLabel">Nuevo Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productoForm">
                    <div class="form-group">
                        <label for="ID_PRODUCTO">ID Producto</label>
                        <input type="text" class="form-control" id="ID_PRODUCTO" name="ID_PRODUCTO" readonly>
                    </div>
                    <div class="form-group">
                        <label for="PROD_NOM">Nombre</label>
                        <input type="text" class="form-control" id="PROD_NOM" name="PROD_NOM" required>
                    </div>
                    <div class="form-group">
                        <label for="PROD_NOMWEB">Nombre Web</label>
                        <input type="text" class="form-control" id="PROD_NOMWEB" name="PROD_NOMWEB" required>
                    </div>
                    <div class="form-group">
                        <label for="DESCRIPCION">Descripción</label>
                        <textarea class="form-control" id="DESCRIPCION" name="DESCRIPCION" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="ID_CATEGORIA">Categoría</label>
                        <select class="form-control" id="ID_CATEGORIA" name="ID_CATEGORIA" required>
                            <option value="C000">Seleccionar</option>
                            <option value="C001">Bebidas Refrescantes</option>
                            <option value="C002">Bakery</option>
                            <option value="C003">Nuestro Café</option>
                            <option value="C004">Sandwiches</option>
                            <option value="C005">Jugos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ProdFchcmrl">Fecha Comercialización</label>
                        <input type="date" class="form-control" id="ProdFchcmrl" name="ProdFchcmrl">
                    </div>
                    <div class="form-group">
                        <label for="PRECIO">Precio</label>
                        <input type="number" class="form-control" id="PRECIO" name="PRECIO" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="ESTADO">Estado</label>
                        <select class="form-control" id="ESTADO" name="ESTADO" required>
                            <option value="1">Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitProduct()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function clearForm() {
        $('#productoForm')[0].reset();
        $('#ID_PRODUCTO').val('');
        $('#productoModalLabel').text('Nuevo Producto');
    }

    function editarProducto(id) {
        $.get(`/Producto/ObtenerProductoPorId?id=${id}`, function (producto) {
            if (producto) {
                $('#ID_PRODUCTO').val(producto.idProducto);
                $('#PROD_NOM').val(producto.prodNom);
                $('#PROD_NOMWEB').val(producto.prodNomWeb);
                $('#DESCRIPCION').val(producto.descripcion);
                $('#ID_CATEGORIA').val(producto.idCategoria);
                $('#PRECIO').val(producto.precio);
                $('#ProdFchcmrl').val(producto.prodFchCmrl ? producto.prodFchCmrl.split('T')[0] : '');
                $('#ESTADO').val(producto.estado);

                $('#productoModalLabel').text('Editar Producto');
                $('#productoModal').modal('show');
            } else {
                alert('No se encontraron datos para este producto.');
            }
        }).fail(function () {
            alert('Error al obtener los datos del producto.');
        });
    }

    function submitProduct() {
        const id = $('#ID_PRODUCTO').val();
        const producto = {
            IdProducto: id || null,
            ProdNom: $('#PROD_NOM').val(),
            ProdNomWeb: $('#PROD_NOMWEB').val(),
            Descripcion: $('#DESCRIPCION').val(),
            IdCategoria: $('#ID_CATEGORIA').val(),
            ProdFchCmrl: $('#ProdFchcmrl').val(),
            Precio: parseFloat($('#PRECIO').val()),
            Estado: parseInt($('#ESTADO').val())
        };

        const url = id ? `/Producto/ActualizarProducto` : `/Producto/InsertarProductos`;

        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(producto),
            success: function (response) {
                if (response.success) {
                    alert(response.message || 'Producto guardado exitosamente.');
                    $('#productoModal').modal('hide');
                    location.reload();
                } else {
                    alert(`Error: ${response.message || 'No se pudo guardar el producto.'}`);
                }
            },
            error: function (xhr) {
                alert(`Error al guardar el producto: ${xhr.responseText || xhr.statusText}`);
            }
        });
    }


    function toggleProduct(id, estado) {
        const url = estado === 1
            ? `/Producto/DesactivarProducto`
            : `/Producto/ActivarProductos`;

        $.post(url, { id: id }, function () {
            location.reload();
        }).fail(function () {
            alert('Error al cambiar el estado del producto.');
        });
    }

</script>
